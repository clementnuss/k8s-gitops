---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: invoiceninja
  namespace: appl-n8r
spec:
  interval: 5m
  chart:
    spec:
      chart: app-template
      version: 4.3.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      interval: 15m
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      invoiceninja:
        strategy: Recreate
        containers:
          app:
            image:
              repository: invoiceninja/invoiceninja-debian
              tag: 5.12.28-d
            env:
              APP_URL: "https://invoiceninja.n8r.ch"
              APP_ENV: production
              REQUIRE_HTTPS: "true"
              TRUSTED_PROXIES: "*"
              DB_HOST: "mariadb-ha-primary.appl-mariadb.svc.cluster.local"
              DB_PORT: "3306"
              DB_DATABASE: "invoiceninja-n8r"
              DB_USERNAME: "invoiceninja-n8r"
              REDIS_HOST: "invoiceninja-redis"
              REDIS_PORT: "6379"
            envFrom:
              - secretRef:
                  name: invoiceninja-env
            resources:
              requests:
                cpu: 150m
                memory: 512Mi
              limits:
                memory: 2Gi

          nginx:
            image:
              repository: nginx
              tag: alpine
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                memory: 128Mi

    service:
      main:
        controller: invoiceninja
        ports:
          http:
            port: 80
            targetPort: 80

    ingress:
      main:
        enabled: true
        className: "nginx"
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
        hosts:
          - host: invoiceninja.n8r.ch
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: main
                  port: http
        tls:
          - secretName: invoiceninja-tls
            hosts:
              - "invoiceninja.n8r.ch"

    persistence:
      public:
        enabled: true
        type: persistentVolumeClaim
        size: 5Gi
        accessMode: ReadWriteOnce
        advancedMounts:
          invoiceninja:
            app:
              - path: /var/www/html/public
            nginx:
              - path: /var/www/html/public
                readOnly: true

      storage:
        enabled: true
        type: persistentVolumeClaim
        size: 5Gi
        accessMode: ReadWriteOnce
        advancedMounts:
          invoiceninja:
            app:
              - path: /var/www/html/storage
            nginx:
              - path: /var/www/html/storage
                readOnly: true

      nginx-config:
        enabled: true
        type: configMap
        name: invoiceninja-nginx-config
        advancedMounts:
          invoiceninja:
            nginx:
              - path: /etc/nginx/conf.d/default.conf
                subPath: default.conf
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: invoiceninja-nginx-config
  namespace: appl-n8r
data:
  default.conf: |
    server {
        listen 80 default_server;
        server_name _;
        root /var/www/html/public;

        client_max_body_size 10M;
        client_body_buffer_size 10M;
        server_tokens off;

        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";

        index index.php;

        charset utf-8;

        gzip on;
        gzip_comp_level 2;
        gzip_min_length 1M;
        gzip_proxied any;
        gzip_types *;

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location = /favicon.ico { access_log off; log_not_found off; }
        location = /robots.txt  { access_log off; log_not_found off; }

        error_page 404 /index.php;

        location ~ \.php$ {
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_buffers 32 16K;
        }

        location ~ /\.(?!well-known).* {
            deny all;
        }
    }
